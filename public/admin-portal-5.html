<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ Heyns Admin Portal - FAA.ZONE™</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for metrics graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Font: Inter (already included, ensuring consistency) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the "Interstellar" theme */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); /* Deep space gradient */
            color: #E0E0E0; /* Light gray for general text */
            line-height: 1.6;
            min-height: 100vh; /* Ensure full viewport height */
            display: flex;
            flex-direction: column;
        }

        /* Header Styling */
        header {
            background-color: rgba(30, 30, 45, 0.9); /* Slightly transparent dark header */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(5px); /* Subtle blur effect */
            border-bottom: 1px solid rgba(70, 70, 90, 0.5); /* Subtle bottom border */
        }
        header a {
            transition: all 0.3s ease-in-out;
            color: #C0C0C0; /* Lighter gray for links */
            padding: 0.6rem 1rem;
            border-radius: 0.5rem; /* More rounded */
            font-weight: 500;
        }
        header a:hover {
            background-color: rgba(60, 60, 90, 0.7); /* Darker hover background */
            color: #93C5FD; /* Light blue accent on hover */
            transform: translateY(-2px); /* Subtle lift effect */
        }
        header a.text-2xl { /* Logo specific styling */
            color: #A78BFA; /* Purple accent for logo */
            font-weight: 800;
        }

        /* Call-to-action Button (cta-button) */
        .cta-button {
            background: linear-gradient(45deg, #6B46C1, #8B5CF6); /* Purple gradient */
            color: white;
            padding: 0.85rem 1.8rem; /* Slightly larger padding */
            border-radius: 0.75rem; /* More rounded */
            font-weight: 700; /* Bolder */
            transition: all 0.4s ease;
            box-shadow: 0 6px 15px rgba(139, 92, 246, 0.4); /* Glow effect */
            position: relative;
            overflow: hidden;
            border: none;
            letter-spacing: 0.05em; /* Slightly spaced out text */
            min-width: 150px; /* Ensure consistent button width */
            text-align: center;
        }
        .cta-button:hover {
            background: linear-gradient(45deg, #7C5BC7, #9B6EF9); /* Slightly lighter gradient on hover */
            transform: translateY(-3px) scale(1.02); /* More pronounced lift and slight scale */
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.6); /* Enhanced glow */
        }
        .cta-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0%;
            height: 0%;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.7s ease-out;
            transform: translate(-50%, -50%);
            opacity: 0;
        }
        .cta-button:hover::before {
            width: 300%;
            height: 300%;
            opacity: 1;
        }

        /* Product Card Styling (adapted for dark theme) */
        .product-card {
            background-color: rgba(25, 25, 40, 0.9); /* Dark card background */
            border-radius: 1rem; /* More rounded */
            border: 1px solid rgba(70, 70, 90, 0.5); /* Subtle border */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5); /* Deeper, softer shadow */
            transition: all 0.4s ease-in-out;
            padding: 2rem; /* More padding */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            /* Changed from min-height to fixed height for perfect alignment */
            height: 600px; /* Adjust this value as needed to fit content + new buttons */
            justify-content: space-between; /* Pushes buttons to bottom */
            position: relative;
            z-index: 2;
        }
        .product-card:hover {
            transform: translateY(-8px) scale(1.01); /* More distinct lift and scale */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7); /* Even deeper shadow on hover */
            border-color: #A78BFA; /* Purple border on hover */
        }
        .product-card.featured {
            border-color: #A78BFA; /* Purple for featured border */
            box-shadow: 0 15px 40px rgba(167, 139, 250, 0.4); /* Featured glow */
        }
        .product-card h3 {
            color: #A78BFA; /* Purple for card titles */
        }
        .product-card p.text-gray-500 {
            color: #B0B0B0; /* Lighter gray for descriptive text */
        }
        .price-display {
            color: #93C5FD; /* Light blue for prices */
        }
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            width: 100%;
            margin-bottom: 2rem;
            flex-grow: 1; /* Allows list to take available space */
        }
        .feature-list li {
            margin-bottom: 0.75rem; /* More spacing */
            display: flex;
            align-items: flex-start; /* Align icon with text top */
            color: #C0C0C0; /* Light gray for features */
            font-size: 0.95rem; /* Slightly larger text */
        }
        .feature-list li svg {
            margin-right: 0.75rem;
            color: #34D399; /* Green accent for checkmarks */
            flex-shrink: 0; /* Prevent icon from shrinking */
            width: 24px; /* Larger icon */
            height: 24px;
        }

        /* Admin specific styles (dark theme adaptation) */
        .admin-main-header {
            background-color: rgba(30, 30, 45, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 2rem; /* More padding */
            border-radius: 1rem;
            margin-bottom: 2.5rem; /* More margin */
            border-top: 8px solid #93C5FD; /* Light blue accent bar */
            color: #E0E0E0;
        }
        .admin-main-header h1 {
            color: #93C5FD; /* Light blue for main heading */
            font-weight: 900;
        }
        .admin-main-header p {
            color: #B0B0B0;
        }

        .admin-nav-scroll {
            background-color: rgba(30, 30, 45, 0.9);
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 1.2rem 2rem; /* More padding */
            margin-bottom: 2.5rem;
            overflow-x: auto;
            white-space: nowrap;
            border: 1px solid rgba(70, 70, 90, 0.5);
        }
        .admin-nav-scroll a {
            @apply px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium; /* Darker hover, lighter text */
            transition: all 0.3s ease-in-out;
        }
        .admin-nav-scroll a.active {
            @apply bg-indigo-800 text-indigo-200 font-semibold; /* Darker indigo for active */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3); /* Inner shadow for active state */
        }

        .admin-panel-card {
            background-color: rgba(25, 25, 40, 0.9);
            border-radius: 1rem;
            border: 1px solid rgba(70, 70, 90, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 2rem;
            margin-bottom: 2.5rem;
            color: #E0E0E0;
        }
        .admin-panel-card h2 {
            color: #93C5FD; /* Light blue for section titles */
        }
        .admin-panel-card h3 {
            color: #A78BFA; /* Purple for sub-titles */
        }
        .admin-panel-card p.text-gray-600 {
            color: #B0B0B0;
        }

        /* Form elements (dark theme) */
        label {
            color: #C0C0C0;
        }
        input, select {
            background-color: rgba(45, 45, 70, 0.8);
            border: 1px solid rgba(80, 80, 100, 0.6);
            color: #E0E0E0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input::placeholder {
            color: #A0A0A0;
        }
        input:focus, select:focus {
            border-color: #93C5FD;
            outline: none;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.5); /* Focus glow */
        }

        /* Table Styling (dark theme) */
        .table-header-style {
            background-color: rgba(45, 45, 70, 0.8);
            color: #A78BFA; /* Purple for header text */
            font-weight: 700;
            border-bottom: 2px solid rgba(100, 100, 120, 0.5);
        }
        .table-row-style {
            border-bottom: 1px solid rgba(70, 70, 90, 0.5);
        }
        .table-row-style:last-child {
            border-bottom: none;
        }
        .table-row-style:hover {
            background-color: rgba(45, 45, 70, 0.5); /* Subtle hover for rows */
        }
        .table-cell-padding {
            padding: 1rem; /* More padding */
            color: #E0E0E0;
        }
        .table-cell-padding button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .table-cell-padding button.bg-blue-500 { /* Inspect button */
            background-color: #60A5FA; /* Brighter blue */
            color: #1F2937;
        }
        .table-cell-padding button.bg-blue-500:hover {
            background-color: #3B82F6;
            transform: translateY(-1px);
        }
        .table-cell-padding button.bg-green-500 { /* Deploy button */
            background: linear-gradient(90deg, #10B981, #059669); /* Green gradient */
            color: white;
        }
        .table-cell-padding button.bg-green-500:hover {
            background: linear-gradient(90deg, #059669, #047857);
            transform: translateY(-1px);
        }

        /* Metrics Cards (dark theme) */
        .metric-card { /* New class for reusability */
            background-color: rgba(35, 35, 55, 0.9); /* Dark background */
            border: 1px solid rgba(70, 70, 90, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-radius: 0.75rem;
            padding: 1.5rem;
            color: #E0E0E0;
        }
        .metric-card h3 {
            color: #93C5FD; /* Light blue for metric titles */
        }
        .metric-card p {
            color: #A78BFA; /* Purple for metric values */
        }


        /* Chart container */
        .w-full.bg-white.p-6.rounded-lg.shadow-inner.border.border-gray-200.h-96 {
            background-color: rgba(25, 25, 40, 0.9);
            border: 1px solid rgba(70, 70, 90, 0.5);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3); /* Inner shadow */
            color: #E0E0E0;
        }
        .w-full.bg-white.p-6.rounded-lg.shadow-inner.border.border-gray-200.h-96 h3 {
            color: #93C5FD;
        }

        /* Sector View specific elements (currency converter and dropdown) */
        .currency-converter-container { /* New class to control this specific block */
            background-color: rgba(45, 45, 70, 0.8); /* Darker background for this specific block */
            border: 1px solid rgba(80, 80, 100, 0.6);
            color: #D0D0D0; /* Light text for general content in this block */
            border-radius: 0.75rem; /* Consistent rounding */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Subtle shadow */
        }
        .currency-converter-container label {
            color: #D0D0D0; /* Ensure label text is also light */
        }
        /* Specific styling for the currency select element itself within the admin portal */
        #sector-currency-select {
            background-color: rgba(60, 60, 90, 0.9); /* Even darker background for the select dropdown */
            border: 1px solid rgba(100, 100, 120, 0.7);
            color: #E0E0E0; /* Light text for the selected option */
        }
        #sector-currency-select option {
            background-color: rgba(60, 60, 90, 0.9); /* Dark background for options */
            color: #E0E0E0; /* Light text for options */
        }

        /* Toggle switch for monthly/annual */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 120px; /* Wider to accommodate text */
            height: 34px;
            margin: 10px 0;
            border-radius: 17px;
            background-color: rgba(70, 70, 90, 0.8); /* Dark background */
            cursor: pointer;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3), 0 1px 0 rgba(255,255,255,0.05);
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: transparent;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 17px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            font-size: 0.85rem;
            font-weight: 600;
            color: #C0C0C0;
            padding: 0 5px; /* Adjust padding to fit text */
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 55px; /* Adjusted width for slider */
            left: 4px;
            bottom: 4px;
            background: linear-gradient(45deg, #60A5FA, #93C5FD); /* Blue gradient for toggle handle */
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 13px; /* Half of height for rounded shape */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input:checked + .slider {
            background-color: transparent;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #93C5FD;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(56px); /* Adjusted translation for wider switch */
            -ms-transform: translateX(56px);
            transform: translateX(56px);
        }
        .slider span {
            z-index: 1; /* Ensure text is above slider */
            user-select: none;
            color: #C0C0C0; /* Default text color */
            transition: color 0.3s ease;
        }
        input:checked + .slider .monthly-text {
            color: #C0C0C0; /* Keep active text dark */
        }
        input:checked + .slider .annual-text {
            color: white; /* Active text is white */
        }
        input:not(:checked) + .slider .monthly-text {
            color: white;
        }
        input:not(:checked) + .slider .annual-text {
            color: #C0C0C0;
        }


        /* Footer Styling */
        footer {
            background-color: rgba(20, 20, 35, 0.9);
            border-top: 1px solid rgba(70, 70, 90, 0.5);
            color: #A0A0A0; /* Slightly darker gray for footer text */
            margin-top: auto; /* Push footer to the bottom */
        }
        .footer-logo-text {
            color: #A78BFA;
            font-weight: 800;
        }
        footer a {
            color: #C0C0C0;
            transition: color 0.3s ease;
        }
        footer a:hover {
            color: #93C5FD;
        }

        /* Specific classes for status messages */
        #adminStatus.text-sm.italic { /* Simplified to apply to base status */
            color: #B0B0B0; /* Light gray for general status */
        }
        #adminStatus.text-red-500 {
            color: #F87171; /* Lighter red for errors */
        }
        #adminStatus.text-green-500 {
            color: #6EE7B7; /* Lighter green for success */
        }
        
        /* Clear data button */
        button.text-sm.text-red-600 {
            color: #EF4444; /* Brighter red for action */
        }
        button.text-sm.text-red-600:hover {
            color: #DC2626;
        }

        /* Adjust Chart.js colors for dark theme */
        .chartjs-render-monitor {
            background-color: transparent !important; /* Ensure canvas background is transparent */
        }
    </style>
</head>
<body class="antialiased">

    <header class="py-4 px-8">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
            <a href="index.html" class="text-2xl font-bold">🦍 FAA.ZONE™</a>
            <nav class="flex flex-wrap justify-center md:justify-end items-center space-x-4 md:space-x-6 text-sm">
                <a href="/">Home</a>
                <a href="/pricing">Pricing & Plans 💰</a>
                <a href="/products">Products</a>
                <a href="/about">About Us ℹ️</a>
                <a href="/contact">Contact Us 📧</a>
            </nav>
        </div>
    </header>

    <main class="main-content p-4 md:p-8 flex-grow">

        <header class="admin-main-header">
            <h1 class="text-3xl font-extrabold">⚙️ Heyns Admin Portal</h1>
            <p class="text-sm mt-1">Corebrands management & AI logic deployment center.</p>
        </header>

        <nav class="admin-nav-scroll flex flex-wrap gap-x-4 gap-y-2 mb-8">
            <a href="#" onclick="window.showAdminSection('add-brand-section', this)" class="active" data-section="add-brand-section">➕ Add Brand & Subnodes</a>
            <a href="#" onclick="window.showAdminSection('global-index-section', this)" data-section="global-index-section">📊 Global Index</a>
            <a href="#" onclick="window.showAdminSection('metrics-section', this)" data-section="metrics-section">📈 Real-Time Metrics</a>
            <a href="#" onclick="window.showAdminSection('sector-view-section', this)" data-section="sector-view-section">🔍 Sector View</a>
        </nav>


        <section id="add-brand-section" class="admin-panel-card space-y-6">
            <h2 class="text-2xl font-bold">Add New Brand & Subnodes</h2>
            <p>Manually add new core brands and their associated subnodes to the FAA.ZONE ecosystem. This updates client-side data and pushes to backend.</p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-sm block font-medium mb-1">📂 Sector</label>
                    <select id="sectorSelect" class="w-full border rounded p-2"></select>
                </div>
                <div>
                    <label class="text-sm block font-medium mb-1">🏷 Brand Name</label>
                    <input id="brandInput" class="w-full border rounded p-2" placeholder="e.g. OmniCastX">
                </div>
                <div>
                    <label class="text-sm block font-medium mb-1">📌 Subnodes (comma-separated)</label>
                    <input id="subnodesInput" class="w-full border rounded p-2" placeholder="e.g. VaultDrop, QRClaim">
                </div>
                <div class="flex items-end">
                    <button id="addBrandBtn" onclick="window.addBrandToSector()" class="cta-button w-full">
                        ➕ Add Brand
                    </button>
                </div>
            </div>
            <p id="adminStatus" class="text-sm italic mt-4">Ready to receive input.</p>
            <div class="mt-4">
                <button onclick="window.clearAdminAddedData()" class="text-sm text-red-600 underline hover:text-red-800 transition">
                    🗑 Clear Locally Added Admin Data (Client-Side)
                </button>
            </div>
        </section>

        <section id="global-index-section" class="admin-panel-card hidden">
            <h2 class="text-2xl font-bold mb-4">📊 FAA.ZONE Global Index — Core Brands Overview</h2>
            <p class="mb-4">A comprehensive list of all core brands within the FAA.ZONE ecosystem, including backend-synced data and client-side additions.</p>
            <div class="overflow-x-auto snapshot-box">
                <table class="min-w-full text-sm text-left">
                    <thead class="table-header-style">
                        <tr>
                            <th class="px-4 py-2">Glyph</th>
                            <th class="px-4 py-2">Sector</th>
                            <th class="px-4 py-2">Core Brands</th>
                            <th class="px-4 py-2">Total Nodes</th>
                            <th class="px-4 py-2">Monthly Fee</th>
                            <th class="px-4 py-2">Annual Fee</th>
                            <th class="px-4 py-2">Payout Tier</th>
                            <th class="px-4 py-2">Region</th>
                            <th class="px-4 py-2">Inspect</th>
                            <th class="px-4 py-2">Deploy</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-200" id="faaZoneIndexTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="metrics-section" class="admin-panel-card hidden">
            <h2 class="text-2xl font-bold mb-4">📈 Real-Time FAA Pulse Metrics</h2>
            <p class="mb-6">Live monitoring of key operational metrics across the ecosystem.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card">
                    <h3 class="font-semibold">🧠 Active Nodes</h3>
                    <p class="text-3xl font-bold mt-2" id="activeNodesCount">0</p>
                </div>
                <div class="metric-card">
                    <h3 class="font-semibold">🔐 Licenses Active</h3>
                    <p class="text-3xl font-bold mt-2" id="licensesActiveCount">0</p>
                </div>
                <div class="metric-card">
                    <h3 class="font-semibold">💾 Vault Deployments</h3>
                    <p class="text-3xl font-bold mt-2" id="vaultDeploymentsCount">0</p>
                </div>
                <div class="metric-card">
                    <h3 class="font-semibold">📥 Sync Logs</h3>
                    <p class="text-3xl font-bold mt-2" id="syncLogsCount">0</p>
                </div>
            </div>
            <div class="w-full bg-white p-6 rounded-lg shadow-inner border h-96">
                <h3 class="text-xl font-bold mb-4">FAA Scroll Pulse Monitor</h3>
                <canvas id="pulseChart" class="w-full h-full"></canvas>
            </div>
        </section>

        <section id="sector-view-section" class="admin-panel-card hidden">
            <h2 class="text-2xl font-bold mb-4">🔍 Sector-Specific View & Snapshots</h2>
            <p class="mb-6">Select a sector to view and manage its brands and subnodes, presented with the chosen product card aesthetic.</p>

            <div class="mb-6 p-4 rounded-lg flex items-center justify-between mx-auto max-w-xs currency-converter-container">
                <label for="sector-currency-select" class="font-medium text-sm">Display prices in:</label>
                <select id="sector-currency-select" class="ml-4 p-2 border rounded-md text-sm">
                    <option value="ZAR">ZAR (R)</option>
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="GBP">GBP (£)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                <div class="col-span-full">
                    <label class="text-sm block font-medium mb-1">Select Sector:</label>
                    <select id="sectorViewSelect" class="w-full border rounded p-2"></select>
                </div>
            </div>
            
            <div id="dynamicSectorDashboard" class="space-y-8">
                <p class="text-gray-400 col-span-full text-center mt-8">Select a sector to view its detailed dashboard.</p>
            </div>
        </section>

    </main>

    <footer class="enhanced-footer text-center py-8 mt-12">
        <div class="container mx-auto px-6">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="text-lg footer-logo-text">FAA.ZONE™</div>
                <p class="text-sm">ScrollGrid · PulseTrade Certified · TreatyMesh Validated</p>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">Privacy</a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">Terms</a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">Contact</a>
                </div>
            </div>
            <p class="text-xs mt-6">© 2025 Fruitful Holdings (Pty) Ltd. All rights reserved.</p>
        </div>
    </footer>

    <!-- PayPal SDK (client-id still needs to be replaced) -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_LIVE_CLIENT_ID&currency=ZAR&vault=true&intent=subscription"></script>

    <script type="module">
        // Wrap the entire script in an IIFE to create a private scope
        (function() {
            // --- Global Data Definitions ---
            const sectorList = {
                "agriculture": "🌱 Agriculture & Biotech",
                "fsf": "🥦 Food, Soil & Farming",
                "banking": "🏦 Banking & Finance",
                "creative": "🖋️ Creative Tech",
                "logistics": "📦 Logistics & Packaging",
                "education-ip": "📚 Education & IP",
                "fashion": "✂ Fashion & Identity",
                "gaming": "🎮 Gaming & Simulation",
                "health": "🧠 Health & Hygiene",
                "housing": "🏗️ Housing & Infrastructure",
                "justice": "⚖ Justice & Ethics",
                "knowledge": "📖 Knowledge & Archives",
                "micromesh": "☰ Micro-Mesh Logistics",
                "media": "🎬 Motion, Media & Sonic",
                "nutrition": "✿ Nutrition & Food Chain",
                "ai-logic": "🧠 AI, Logic & Grid", 
                "packaging": "📦 Packaging & Materials",
                "quantum": "✴️ Quantum Protocols",
                "ritual": "☯ Ritual & Culture",
                "saas": "🔑 SaaS & Licensing",
                "trade": "🧺 Trade Systems",
                "utilities": "🔋 Utilities & Energy",
                "voice": "🎙️ Voice & Audio",
                "webless": "📡 Webless Tech & Nodes",
                "nft": "🔁 NFT & Ownership",
                "education-youth": "🎓 Education & Youth",
                "zerowaste": "♻️ Zero Waste",
                "professional": "🧾 Professional Services",
                "payroll-mining": "🪙 Payroll Mining & Accounting",
                "mining": "⛏️ Mining & Resources", 
                "wildlife": "🦁 Wildlife & Habitat",
                "admin-panel": "⚙️ Admin Panel" 
            };

            const FAA_ZONE_INDEX_SUMMARY_DATA = {
                "agriculture": { glyph: "🌱", monthlyFee: "550.00", annualFee: "5500.00", payoutTier: "B+", region: "Global Rural" },
                "fsf": { glyph: "🥦", monthlyFee: "560.00", annualFee: "5800.00", payoutTier: "B+", region: "Rural" },
                "banking": { glyph: "🏦", monthlyFee: "1250.00", annualFee: "12500.00", payoutTier: "A+", region: "Div A-E" },
                "creative": { glyph: "🖋️", monthlyFee: "700.00", annualFee: "7500.00", payoutTier: "A", region: "Div E" },
                "logistics": { glyph: "📦", monthlyFee: "600.00", annualFee: "6100.00", payoutTier: "B+", region: "Div B-F" },
                "education-ip": { glyph: "📚", monthlyFee: "400.00", annualFee: "4300.00", payoutTier: "A", region: "Tribal/Global" },
                "fashion": { glyph: "✂", monthlyFee: "720.00", annualFee: "7800.00", payoutTier: "A", region: "Global Metro" },
                "gaming": { glyph: "🎮", monthlyFee: "850.00", annualFee: "8700.00", payoutTier: "A", region: "Global Digital" },
                "health": { glyph: "🧠", monthlyFee: "550.00", annualFee: "5800.00", payoutTier: "B", region: "Div F" },
                "housing": { glyph: "🏗️", monthlyFee: "620.00", annualFee: "6400.00", payoutTier: "B+", region: "Div A-F" },
                "justice": { glyph: "⚖", monthlyFee: "950.00", annualFee: "9800.00", payoutTier: "A", region: "Global Legal" },
                "knowledge": { glyph: "📖", monthlyFee: "580.00", annualFee: "6100.00", payoutTier: "B+", region: "Global Archives" },
                "micromesh": { glyph: "☰", monthlyFee: "650.00", annualFee: "6800.00", payoutTier: "B+", region: "Local/Regional" },
                "media": { glyph: "🎬", monthlyFee: "750.00", annualFee: "7700.00", payoutTier: "A", region: "Creative" },
                "nutrition": { glyph: "✿", monthlyFee: "500.00", annualFee: "5300.00", payoutTier: "B+", region: "Global" },
                "ai-logic": { glyph: "🧠", monthlyFee: "1100.00", annualFee: "11200.00", payoutTier: "A+", region: "Global" },
                "packaging": { glyph: "📦", monthlyFee: "680.00", annualFee: "7000.00", payoutTier: "B", region: "Div B" },
                "quantum": { glyph: "✴️", monthlyFee: "1350.00", annualFee: "13800.00", payoutTier: "A+", region: "Global Research" },
                "ritual": { glyph: "☯", monthlyFee: "700.00", annualFee: "7500.00", payoutTier: "A", region: "Div C" },
                "saas": { glyph: "🔑", monthlyFee: "1000.00", annualFee: "10300.00", payoutTier: "A", region: "Global" },
                "trade": { glyph: "🧺", monthlyFee: "900.00", annualFee: "9200.00", payoutTier: "A+", region: "Div A-F" },
                "utilities": { glyph: "🔋", monthlyFee: "750.00", annualFee: "7800.00", payoutTier: "B+", region: "Div A-Z" },
                "voice": { glyph: "🎙️", monthlyFee: "630.00", annualFee: "6600.00", payoutTier: "B", region: "Global" },
                "webless": { glyph: "📡", monthlyFee: "800.00", annualFee: "8200.00", payoutTier: "A", region: "Div D-G" },
                "nft": { glyph: "🔁", monthlyFee: "1250.00", annualFee: "12800.00", payoutTier: "A", region: "FAA IP" },
                "education-youth": { glyph: "🎓", monthlyFee: "420.00", annualFee: "4500.00", payoutTier: "A", region: "Global Youth" },
                "zerowaste": { glyph: "♻️", monthlyFee: "450.00", annualFee: "4800.00", payoutTier: "B", region: "Global" },
                "professional": { glyph: "🧾", monthlyFee: "1150.00", annualFee: "11800.00", payoutTier: "A", region: "Global" },
                "payroll-mining": { glyph: "🪙", monthlyFee: "1050.00", annualFee: "10800.00", payoutTier: "A+", region: "Global Finance" },
                "mining": { glyph: "⛏️", monthlyFee: "1600.00", annualFee: "19000.00", payoutTier: "A+", region: "Global Resources" },
                "wildlife": { glyph: "🦁", monthlyFee: "400.00", annualFee: "4200.00", payoutTier: "B", region: "Conservation Zones" }
            };

            const ALL_SECTOR_DATA_STATIC = {
                // Ensure this structure accurately reflects brands and their subnodes for each sector
                "agriculture": { brands: ['AgroChain', 'CropSense'], subNodes: [['YieldNode', 'SoilScan'], ['PestDetect']] },
                "fsf": { brands: ['FarmFresh', 'NutriScore'], subNodes: [['BioTrack'], ['FoodPrint']] },
                "banking": { brands: ['FinFlow', 'TrustVault'], subNodes: [['TransactNode', 'LedgerLink'], ['SecureKey']] },
                "creative": { brands: ['ArtStream', 'DesignHub'], subNodes: [['PixelNode'], ['IdeaGrid']] },
                "logistics": { brands: ['RouteWise', 'CargoFlow'], subNodes: [['TrackNode', 'PalletSync'], ['FreightNet']] },
                "education-ip": { brands: ['LearnPath', 'IPGuard'], subNodes: [['CourseLink'], ['PatentSecure']] },
                "fashion": { brands: ['StyleGrid', 'TrendWeave'], subNodes: [['FabricTrace'], ['DesignFlow']] },
                "gaming": { brands: ['GameForge', 'PlayNexus'], subNodes: [['RenderNode', 'MatchSync'], ['QuestHub']] },
                "health": { brands: ['MediConnect', 'VitalTrack'], subNodes: [['EHRNode', 'TeleMed'], ['WellnessPulse']] },
                "housing": { brands: ['HomeBlock', 'UrbanGrid'], subNodes: [['PropChain'], ['CityScan']] },
                "justice": { brands: ['LawLedger', 'EthiTrust'], subNodes: [['CaseTrack'], ['MoralGraph']] },
                "knowledge": { brands: ['DataVerse', 'LoreKeeper'], subNodes: [['ArchiveNode', 'InfoFlow'], ['WikiLink']] },
                "micromesh": { brands: ['MicroSync', 'EdgeLink'], subNodes: [['SmallNode'], ['LocalHub']] },
                "media": { brands: ['FrameCast', 'SonicWave'], subNodes: [['VideoNode', 'AudioSync'], ['StreamPulse']], scrollProfiles: {"FrameCast": { title: "FrameCast™ Product Scroll", intro: "FrameCast™ is a protocol for secure, verifiable media streaming.", features: ["Secure streaming"], pricing: ["Basic – R100/mo"], metadata: { id: "FC-1", vault: "V1", layer: "L1" } } } },
                "nutrition": { brands: ['NutriLife', 'FoodSense'], subNodes: [['DietNode'], ['IngestTrack']] },
                "ai-logic": { brands: ['OmniKey', 'CogniGrid'], subNodes: [['BrainNode', 'LogicLink'], ['SynapseNet']] },
                "packaging": { brands: ['PackChain', 'EcoPack'], subNodes: [['BoxTrack'], ['GreenWrap']] },
                "quantum": { brands: ['QuantumMesh', 'EntangleSec'], subNodes: [['QubitNode'], ['CryptoLink']] },
                "ritual": { brands: ['RiteNode', 'CultureWeave'], subNodes: [['TraditionSync'], ['CeremonyLink']] },
                "saas": { brands: ['SaaSFlow', 'AppServe'], subNodes: [['CloudNode'], ['LicenceKey']] },
                "trade": { brands: ['TradeLink', 'MarketFlow'], subNodes: [['ExchangeNode'], ['DemandTrack']] },
                "utilities": { brands: ['PowerGrid', 'WaterSense'], subNodes: [['EnergyNode'], ['HydroLink']] },
                "voice": { brands: ['VoiceSynth', 'EchoSphere'], subNodes: [['VocalNode'], ['AudioID']] },
                "webless": { brands: ['OmniQR', 'DirectLink'], subNodes: [['BeaconNode'], ['OfflineSync']] },
                "nft": { brands: ['ClaimGrid', 'ArtToken'], subNodes: [['AssetNode'], ['RoyaltyFlow']] },
                "education-youth": { brands: ['EduKidz', 'FutureMinds'], subNodes: [['PlayLearnNode'], ['SkillTrack']] },
                "zerowaste": { brands: ['EcoCycle', 'ReGen'], subNodes: [['RecycleNode'], ['CompostTrack']] },
                "professional": { brands: ['ProAssist', 'LegalVault'], subNodes: [['ConsultNode'], ['DocuChain']] },
                "payroll-mining": { brands: ['PayMine', 'CoinRoll'], subNodes: [['WageNode'], ['MineProof']] },
                "mining": { brands: ['MineCore', 'ResourceFlow'], subNodes: [['ExtractNode'], ['RefineLink']] },
                "wildlife": { brands: ['WildGuard', 'BioPreserve'], subNodes: [['TrackerNode'], ['HabitatLink']] },
            };

            // Client-side data storage for admin additions, initialized from localStorage
            let clientAdminData = JSON.parse(localStorage.getItem("clientAdminData")) || {};
            // Ensure clientAdminData structure for all sectors
            for (const key in sectorList) {
                if (!clientAdminData[key]) {
                    clientAdminData[key] = { brands: [], nodes: [] };
                }
            }

            let currentActivePanelId = null; 
            let activeBrandButton = null; 

            // --- Chart & App Logic (for dashboard metrics) ---
            let pulseChartInstance = null; 
            const chartTimeLabels = Array.from({ length: 10 }, (_, i) => `T-${(9-i)*3}s`); 
            chartTimeLabels[9] = "Now";

            const chartDataPoints = {
                activeNodes: Array(10).fill(0),
                licensesActive: Array(10).fill(0),
                vaultDeployments: Array(10).fill(0)
            };

            let currentGlobalMetrics = {
                activeNodes: 0, licensesActive: 0, vaultDeployments: 0,
                syncLogs: 0, auditsRunning: 0, signalZones: 0, scrollGridIndex: 0
            };

            // --- Currency Converter Logic ---
            let exchangeRates = {}; 
            const API_KEY = "40015d117bc7fff9495dcf28"; // Your provided API key
            const BASE_CURRENCY = 'ZAR'; 

            // --- Pricing data for sectors, pulled from FAA_ZONE_INDEX_SUMMARY_DATA ---
            const SECTOR_TIER_PRICING = {
                "Starter": {
                    features: ["Basic API Access", "Standard Analytics Dashboard", "Community Support", "Up to 5 Users"],
                    monthlyMetrics: { "Active Users": "5", "API Calls/Month": "10k", "Storage": "1GB" },
                },
                "Pro": {
                    features: ["Advanced API Access", "Premium Analytics & Reporting", "Dedicated Priority Support", "Unlimited Users", "Custom Data Integrations"],
                    monthlyMetrics: { "Active Users": "Unlimited", "API Calls/Month": "100k", "Storage": "10GB" },
                },
                "Enterprise": {
                    features: ["All Business Package Features", "Dedicated Account Manager", "24/7 Phone Support", "Enhanced Custom Integrations", "On-site Training & Setup"],
                    monthlyMetrics: { "Active Users": "Unlimited", "API Calls/Month": "Custom", "Storage": "Custom" },
                }
            };

            // --- Expose functions to the global scope for HTML onclick attributes ---
            window.showAdminSection = showAdminSection;
            window.addBrandToSector = addBrandToSector;
            window.clearAdminAddedData = clearAdminAddedData;
            window.displaySectorSpecificProducts = displaySectorSpecificProducts; // Keep this function for sector view
            window.deploySectorPlanToPayPal = deploySectorPlanToPayPal;
            window.initiatePayPalSubscription = initiatePayPalSubscription;
            window.getCurrencySymbol = getCurrencySymbol;
            window.exchangeRates = exchangeRates; 
            window.BASE_CURRENCY = BASE_CURRENCY; 
            window.toggleSubscriptionType = toggleSubscriptionType; // Expose toggle function


            // --- Admin Panel Core Functions ---
            function showAdminSection(sectionId, clickedLink) {
                document.querySelectorAll('section[id$="-section"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.admin-nav-scroll a').forEach(link => link.classList.remove('active'));

                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('hidden');
                    if (clickedLink) {
                        clickedLink.classList.add('active');
                        currentActivePanelId = sectionId; 
                    }
                    if (sectionId === 'metrics-section') {
                        if (!pulseChartInstance) {
                            renderDynamicPulseChart();
                            setInterval(updateDynamicPulseChart, 3000);
                        }
                    }
                    if (sectionId === 'global-index-section' || sectionId === 'add-brand-section') {
                        renderFaaZoneIndexTable();
                        calculateGlobalMetrics();
                    }
                    if (sectionId === 'sector-view-section') {
                        populateSectorViewSelect();
                        const sectorViewSelect = document.getElementById('sectorViewSelect');
                        // Trigger initial render for the first sector in the dropdown, if not already set
                        if (sectorViewSelect.value === '' && Object.keys(sectorList).filter(key => key !== 'admin-panel').length > 0) {
                            sectorViewSelect.value = Object.keys(sectorList).filter(key => key !== 'admin-panel')[0]; // Set default
                            displaySectorSpecificProducts(sectorViewSelect.value); // Display for default
                        } else if (sectorViewSelect.value !== '') {
                             displaySectorSpecificProducts(sectorViewSelect.value); // Redisplay if already selected
                        }
                    }
                }
            }

            function populateSectorSelect() {
                const select = document.getElementById('sectorSelect');
                if (!select) return;
                select.innerHTML = '';
                Object.entries(sectorList).forEach(([key, label]) => {
                    if (key !== 'admin-panel') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = label;
                        select.appendChild(option);
                    }
                });
            }
            
            function populateSectorViewSelect() {
                const select = document.getElementById('sectorViewSelect');
                if (!select) return;
                select.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '--- Select a Sector ---';
                select.appendChild(defaultOption);

                Object.entries(sectorList).forEach(([key, label]) => {
                    if (key !== 'admin-panel') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = label;
                        select.appendChild(option);
                    }
                });

                // Attach event listener only once
                select.removeEventListener('change', handleSectorViewChange); // Prevent multiple listeners
                select.addEventListener('change', handleSectorViewChange);
            }

            function handleSectorViewChange(event) {
                const selectedSectorKey = event.target.value;
                if (selectedSectorKey) {
                    displaySectorSpecificProducts(selectedSectorKey);
                } else {
                    document.getElementById('dynamicSectorDashboard').innerHTML = '<p class="text-gray-400 col-span-full text-center mt-8">Select a sector to view its detailed dashboard.</p>';
                }
            }


            function addBrandToSector() {
                const sectorSelect = document.getElementById("sectorSelect");
                const brandInput = document.getElementById("brandInput");
                const subnodesInput = document.getElementById("subnodesInput");
                const adminStatus = document.getElementById("adminStatus");
                const addBrandBtn = document.getElementById("addBrandBtn");

                const sectorKey = sectorSelect.value;
                const brandName = brandInput.value.trim();
                const subnodesArray = subnodesInput.value.split(",").map(n => n.trim()).filter(Boolean);

                if (!brandName || subnodesArray.length === 0) {
                    adminStatus.textContent = "⚠️ Please fill in both brand name and at least one subnode.";
                    addBrandBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    addBrandBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    setTimeout(() => { 
                        adminStatus.textContent = "Ready to receive input.";
                        addBrandBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                        addBrandBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }, 3000);
                    return;
                }

                // Simulate backend call
                console.log(`Attempting to add brand "${brandName}" with subnodes [${subnodesArray.join(', ')}] to sector "${sectorKey}"`);
                // In a real application, you would send this to your backend
                // fetch('http://localhost:5000/api/sectors', { ... }) 
                
                // For demonstration, directly update clientAdminData and simulate success
                return new Promise(resolve => {
                    setTimeout(() => { // Simulate network delay
                        if (!clientAdminData[sectorKey]) {
                            clientAdminData[sectorKey] = { brands: [], nodes: [] };
                        }
                        clientAdminData[sectorKey].brands.push(brandName);
                        clientAdminData[sectorKey].nodes.push(subnodesArray); // Store subnodes as an array for the new brand
                        localStorage.setItem("clientAdminData", JSON.stringify(clientAdminData));

                        console.log("💾 Data saved to client-side localStorage and simulated backend success.");
                        adminStatus.textContent = `✅ Added ${brandName} to ${sectorList[sectorKey]} (Client-side & simulated Backend).`;
                        addBrandBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        addBrandBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        addBrandBtn.innerHTML = '✔️ Added!';
                        
                        // Re-render relevant sections after adding data
                        renderFaaZoneIndexTable(); 
                        calculateGlobalMetrics(); 
                        // If the "Sector View" is active for this sector, re-render it
                        if (currentActivePanelId === 'sector-view-section' && document.getElementById('sectorViewSelect').value === sectorKey) {
                            displaySectorSpecificProducts(sectorKey);
                        }

                        brandInput.value = "";
                        subnodesInput.value = "";
                        resolve();
                    }, 1000); // 1 second delay
                })
                .catch(err => {
                    console.error("❌ Error simulating data save:", err);
                    adminStatus.textContent = "❌ Failed to save. Check console.";
                    addBrandBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    addBrandBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    addBrandBtn.innerHTML = 'Failed!';
                })
                .finally(() => {
                    setTimeout(() => { 
                        adminStatus.textContent = "Ready to receive input."; 
                        addBrandBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-red-500', 'hover:bg-red-600');
                        addBrandBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                        addBrandBtn.innerHTML = '➕ Add Brand';
                    }, 3000);
                });
            }
            
            function clearAdminAddedData() {
                localStorage.removeItem("clientAdminData");
                clientAdminData = {};
                for (const key in sectorList) {
                    clientAdminData[key] = { brands: [], nodes: [] };
                }
                renderFaaZoneIndexTable();
                calculateGlobalMetrics();
                document.getElementById('dynamicSectorDashboard').innerHTML = '<p class="text-gray-400 col-span-full text-center mt-8">Select a sector to view its detailed dashboard.</p>';

                document.getElementById("adminStatus").textContent = "🗑️ Client-side admin data cleared.";
                setTimeout(() => { document.getElementById("adminStatus").textContent = "Ready to receive input."; }, 3000);
            }
            
            // Function to toggle between monthly and annual prices
            function toggleSubscriptionType(cardElement, isAnnual) {
                const priceSpan = cardElement.querySelector('.price-display');
                const originalMonthlyPrice = parseFloat(priceSpan.dataset.originalMonthlyPrice);
                const originalAnnualPrice = parseFloat(priceSpan.dataset.originalAnnualPrice);
                const currentCurrency = priceSpan.dataset.currencyCode || BASE_CURRENCY; // Get currently displayed currency

                let newPrice;
                let newBillingCycle;

                if (isAnnual) {
                    newPrice = originalAnnualPrice;
                    newBillingCycle = "ANNUAL";
                    priceSpan.innerHTML = `${window.getCurrencySymbol(currentCurrency)}${newPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span class="text-xl text-gray-400">/ year</span>`;
                } else {
                    newPrice = originalMonthlyPrice;
                    newBillingCycle = "MONTHLY";
                    priceSpan.innerHTML = `${window.getCurrencySymbol(currentCurrency)}${newPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span class="text-xl text-gray-400">/ month</span>`;
                }

                // Update the PayPal button's data attributes
                const buyButton = cardElement.querySelector('.buy-now-button');
                buyButton.dataset.amount = newPrice.toFixed(2); // Always update with the ZAR base amount
                buyButton.dataset.billingCycle = newBillingCycle;
                buyButton.dataset.planKey = `${buyButton.dataset.itemName.replace(/\s/g, '_')}_${newBillingCycle}`;
            }

            // --- Sector-Specific Product Card Generation Function (for Admin) ---
            function displaySectorSpecificProducts(sectorKey) {
                const container = document.getElementById('dynamicSectorDashboard');
                if (!container) {
                    console.error("Dynamic sector dashboard container not found!");
                    return;
                }
                container.innerHTML = ''; // Clear previous content

                const sectorData = FAA_ZONE_INDEX_SUMMARY_DATA[sectorKey];
                if (!sectorData) {
                    container.innerHTML = `<p class="text-gray-400 col-span-full text-center mt-8">No pricing data available for this sector.</p>`;
                    return;
                }

                const baseMonthlyFee = parseFloat(String(sectorData.monthlyFee).replace('$', '').replace(',', ''));
                const annualDiscount = 0.15; // 15% discount for annual

                const products = [
                    { 
                        name: `${sectorList[sectorKey].replace(/<.*?>/g, '')} Starter Package`, 
                        monthlyAmount: baseMonthlyFee, 
                        annualAmount: (baseMonthlyFee * 12 * (1 - annualDiscount)), 
                        tier: "Starter" 
                    },
                    { 
                        name: `${sectorList[sectorKey].replace(/<.*?>/g, '')} Pro Package`, 
                        monthlyAmount: (baseMonthlyFee * 2.5), 
                        annualAmount: (baseMonthlyFee * 2.5 * 12 * (1 - annualDiscount)), 
                        tier: "Pro", featured: true 
                    },
                    { 
                        name: `${sectorList[sectorKey].replace(/<.*?>/g, '')} Enterprise Package`, 
                        monthlyAmount: (baseMonthlyFee * 5), 
                        annualAmount: (baseMonthlyFee * 5 * 12 * (1 - annualDiscount)), 
                        tier: "Enterprise" 
                    }
                ];

                // Section for Pricing Tiers
                let pricingHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-8">`;
                products.forEach(product => {
                    const tierInfo = SECTOR_TIER_PRICING[product.tier];
                    if (!tierInfo) return;

                    pricingHtml += `
                        <div class="col-span-1">
                            <div class="product-card p-6 md:p-8 ${product.featured ? 'featured' : ''}">
                                <div>
                                    <h3 class="text-2xl font-bold mb-4">${product.name}</h3>
                                    <p class="text-gray-400 mb-6">Unlock powerful features for ${product.tier} success.</p>
                                    
                                    <!-- Toggle Switch for Monthly/Annual -->
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="window.toggleSubscriptionType(this.closest('.product-card'), this.checked)">
                                        <span class="slider">
                                            <span class="monthly-text">Monthly</span>
                                            <span class="annual-text">Annual (15% off)</span>
                                        </span>
                                    </label>

                                    <div class="mb-8">
                                        <span class="text-5xl font-extrabold ${product.featured ? 'text-blue-400' : 'text-gray-100'} price-display" 
                                            data-original-monthly-price="${product.monthlyAmount.toFixed(2)}" 
                                            data-original-annual-price="${product.annualAmount.toFixed(2)}"
                                            data-currency-symbol="R"
                                            data-currency-code="ZAR"> <!-- Initial currency -->
                                            R${parseFloat(product.monthlyAmount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} 
                                            <span class="text-xl text-gray-400">/ month</span>
                                        </span>
                                    </div>
                                    <ul class="feature-list mb-8">
                                        ${tierInfo.features.map(f => `
                                            <li><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>${f}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <button class="buy-now-button cta-button w-full"
                                        data-item-name="${product.name}"
                                        data-amount="${product.monthlyAmount.toFixed(2)}"
                                        data-item-description="Monthly subscription for ${product.name}."
                                        data-billing-cycle="MONTHLY"
                                        data-plan-key="${product.name.replace(/\s/g, '_')}_MONTHLY"
                                        onclick="window.initiatePayPalSubscription(event)">
                                    Subscribe Now
                                </button>
                            </div>
                        </div>
                    `;
                });
                pricingHtml += `</div>`;
                container.innerHTML += `<h2 class="text-2xl font-bold mb-4">Pricing for ${sectorList[sectorKey]}</h2>${pricingHtml}`;

                // Section for Tier-Specific Metrics
                let tierMetricsHtml = `<div class="admin-panel-card mt-8">
                    <h3 class="text-2xl font-bold mb-4">Tier-Specific Metrics for ${sectorList[sectorKey]}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">`;
                
                products.forEach(product => {
                    const tierMetrics = SECTOR_TIER_PRICING[product.tier].monthlyMetrics;
                    if (!tierMetrics) return;

                    tierMetricsHtml += `
                        <div class="metric-card">
                            <h4 class="font-semibold text-xl mb-2">${product.name} Metrics</h4>
                            <ul class="list-none p-0 m-0 space-y-1">
                                ${Object.entries(tierMetrics).map(([key, value]) => `
                                    <li><span class="font-medium text-gray-300">${key}:</span> <span class="text-purple-300">${value}</span></li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                });
                tierMetricsHtml += `</div></div>`;
                container.innerHTML += tierMetricsHtml;


                // Section for Brands and Subnodes (Existing)
                const currentSectorStaticData = ALL_SECTOR_DATA_STATIC[sectorKey];
                const currentSectorClientData = clientAdminData[sectorKey];

                const allBrands = [
                    ...(currentSectorStaticData?.brands || []),
                    ...(currentSectorClientData?.brands || [])
                ];
                const allSubNodes = [
                    ...(currentSectorStaticData?.subNodes || []).flat(),
                    ...(currentSectorClientData?.nodes || []).flat()
                ];

                let brandsAndNodesHtml = `
                    <div class="admin-panel-card mt-8">
                        <h3 class="text-2xl font-bold mb-4">Brands & Subnodes in ${sectorList[sectorKey]}</h3>
                `;

                if (allBrands.length > 0) {
                    brandsAndNodesHtml += `<h4 class="text-lg font-semibold mt-2 mb-2">Brands:</h4><ul class="list-disc list-inside space-y-1">`;
                    allBrands.forEach(brand => {
                        brandsAndNodesHtml += `<li>${brand}</li>`;
                    });
                    brandsAndNodesHtml += `</ul>`;
                } else {
                    brandsAndNodesHtml += `<p>No brands currently listed for this sector.</p>`;
                }

                if (allSubNodes.length > 0) {
                    brandsAndNodesHtml += `<h4 class="text-lg font-semibold mt-4 mb-2">Subnodes:</h4><ul class="list-disc list-inside space-y-1">`;
                    allSubNodes.forEach(node => {
                        brandsAndNodesHtml += `<li>${node}</li>`;
                    });
                    brandsAndNodesHtml += `</ul>`;
                } else {
                    brandsAndNodesHtml += `<p class="mt-2">No subnodes currently listed for this sector.</p>`;
                }

                brandsAndNodesHtml += `</div>`;
                container.innerHTML += brandsAndNodesHtml;

                // Apply currency conversion to the newly rendered price displays
                const sectorPriceDisplays = container.querySelectorAll('.price-display');
                const sectorCurrencySelect = document.getElementById('sector-currency-select');
                if (sectorCurrencySelect && typeof window.getCurrencySymbol === 'function' && typeof window.exchangeRates !== 'undefined') {
                    // Update prices based on current selection
                    updatePricesInSectorView(sectorPriceDisplays, sectorCurrencySelect.value);
                } else {
                    console.warn("Currency converter or its dependencies not fully initialized for sector view.");
                }
            }


            // --- Global Metrics & Chart Functions (from previous version) ---
            function calculateGlobalMetrics() {
                let tempActiveNodes = 0;
                let tempLicensesActive = 0;
                let tempVaultDeployments = 0;
                let tempSyncLogs = 0;
                // These are not yet used in display, but calculated here for consistency
                let tempAuditsRunning = 0; 
                let tempSignalZones = 0; 
                let tempScrollGridIndex = 0;

                for (const sectorKey in FAA_ZONE_INDEX_SUMMARY_DATA) {
                    if (sectorKey === 'admin-panel') continue; 

                    const staticData = ALL_SECTOR_DATA_STATIC[sectorKey];
                    const adminData = clientAdminData[sectorKey];

                    const staticBrandsCount = staticData?.brands?.length || 0;
                    // Sum up all subnodes from static data
                    const staticNodesCount = (staticData?.subNodes || []).reduce((acc, subnodeArray) => acc + subnodeArray.length, 0);
                    
                    const adminBrandsCount = adminData?.brands?.length || 0;
                    // Sum up all subnodes from client-added data
                    const adminNodesCount = (adminData?.nodes || []).reduce((acc, subnodeArray) => acc + subnodeArray.length, 0);

                    const totalCoreBrands = staticBrandsCount + adminBrandsCount;
                    const totalNodes = staticNodesCount + adminNodesCount;
                    
                    // Corrected: Use totalCoreBrands instead of undefined totalBrandsForSector
                    tempActiveNodes += totalCoreBrands; 
                    tempLicensesActive += totalCoreBrands * 2; 
                    tempVaultDeployments += totalCoreBrands * 1.5; 
                    tempSyncLogs += totalCoreBrands * 5; 
                    tempAuditsRunning += Math.ceil(totalCoreBrands / 10); 
                    tempSignalZones += Math.floor(totalCoreBrands / 3); 
                    tempScrollGridIndex += (totalCoreBrands + totalNodes); 
                }
                
                currentGlobalMetrics.activeNodes = tempActiveNodes;
                currentGlobalMetrics.licensesActive = tempLicensesActive;
                currentGlobalMetrics.vaultDeployments = Math.round(tempVaultDeployments);
                currentGlobalMetrics.syncLogs = tempSyncLogs;
                currentGlobalMetrics.auditsRunning = tempAuditsRunning;
                currentGlobalMetrics.signalZones = tempSignalZones;
                currentGlobalMetrics.scrollGridIndex = tempScrollGridIndex;

                document.getElementById("activeNodesCount").textContent = currentGlobalMetrics.activeNodes.toLocaleString();
                document.getElementById("licensesActiveCount").textContent = currentGlobalMetrics.licensesActive.toLocaleString();
                document.getElementById("vaultDeploymentsCount").textContent = currentGlobalMetrics.vaultDeployments.toLocaleString();
                document.getElementById("syncLogsCount").textContent = currentGlobalMetrics.syncLogs.toLocaleString();
                // If you add these elements to your HTML, they will now be updated:
                // document.getElementById("auditsRunningCount").textContent = currentGlobalMetrics.auditsRunning.toLocaleString();
                // document.getElementById("signalZonesCount").textContent = currentGlobalMetrics.signalZones.toLocaleString();
                // document.getElementById("scrollGridIndexCount").textContent = currentGlobalMetrics.scrollGridIndex.toLocaleString();
            }

            function renderDynamicPulseChart() {
                const ctxEl = document.getElementById("pulseChart");
                if (!ctxEl) { console.error("Canvas element for pulseChart not found!"); return; }
                const ctx = ctxEl.getContext("2d");

                if (pulseChartInstance) { pulseChartInstance.destroy(); }
                
                calculateGlobalMetrics(); 
                chartDataPoints.activeNodes = Array(10).fill(currentGlobalMetrics.activeNodes);
                chartDataPoints.licensesActive = Array(10).fill(currentGlobalMetrics.licensesActive);
                chartDataPoints.vaultDeployments = Array(10).fill(currentGlobalMetrics.vaultDeployments);


                pulseChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...chartTimeLabels], 
                        datasets: [
                            { label: 'Active Nodes', data: [...chartDataPoints.activeNodes], borderColor: '#60A5FA', backgroundColor: 'rgba(96, 165, 250, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2, pointHoverRadius: 4 },
                            { label: 'Licenses Active', data: [...chartDataPoints.licensesActive], borderColor: '#34D399', backgroundColor: 'rgba(52, 211, 153, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2, pointHoverRadius: 4 },
                            { label: 'Vault Deployments', data: [...chartDataPoints.vaultDeployments], borderColor: '#FCD34D', backgroundColor: 'rgba(252, 211, 77, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2, pointHoverRadius: 4 }
                        ]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, animation: { duration: 500 }, 
                        plugins: { legend: { display: true, position: 'top', labels: { color: "#C0C0C0" } }, tooltip: { mode: 'index', intersect: false } }, 
                        scales: { 
                            y: { beginAtZero: true, ticks: { color: "#A0A0A0" }, title: { display: true, text: 'Count', color: '#C0C0C0'}}, 
                            x: { ticks: { color: "#A0A0A0" }, title: {display: true, text: 'Time (Updates every 3s)', color: '#C0C0C0'} } 
                        } 
                    }
                });
            }

            function updateDynamicPulseChart() {
                if (!pulseChartInstance) return;
                
                calculateGlobalMetrics(); 

                chartDataPoints.activeNodes.shift();
                chartDataPoints.licensesActive.shift();
                chartDataPoints.vaultDeployments.shift();

                chartDataPoints.activeNodes.push(currentGlobalMetrics.activeNodes);
                chartDataPoints.licensesActive.push(currentGlobalMetrics.licensesActive);
                chartDataPoints.vaultDeployments.push(currentGlobalMetrics.vaultDeployments);
                
                pulseChartInstance.data.datasets[0].data = [...chartDataPoints.activeNodes];
                pulseChartInstance.data.datasets[1].data = [...chartDataPoints.licensesActive];
                pulseChartInstance.data.datasets[2].data = [...chartDataPoints.vaultDeployments];
                
                pulseChartInstance.update();
            }

            // --- FAA.ZONE INDEX Table Renderer ---
            function renderFaaZoneIndexTable() {
                const tableBody = document.getElementById("faaZoneIndexTableBody");
                if (!tableBody) {
                    console.error("FAA Zone Index table body not found.");
                    return;
                }
                tableBody.innerHTML = ''; // Clear existing content

                const sectorsToDisplay = Object.keys(FAA_ZONE_INDEX_SUMMARY_DATA);
                
                sectorsToDisplay.sort((a, b) => {
                    const nameA = sectorList[a] || a;
                    const nameB = sectorList[b] || b;
                    return nameA.localeCompare(nameB);
                });

                sectorsToDisplay.forEach(sectorKey => {
                    const summary = FAA_ZONE_INDEX_SUMMARY_DATA[sectorKey];
                    if (!summary) { 
                        console.warn(`Summary data missing for sector: ${sectorKey} in FAA_ZONE_INDEX_SUMMARY_DATA`);
                        return; 
                    }
                    const displayName = sectorList[sectorKey] || sectorKey.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    const staticData = ALL_SECTOR_DATA_STATIC[sectorKey];
                    const adminData = clientAdminData[sectorKey];

                    const staticBrandsCount = staticData?.brands?.length || 0;
                    const staticNodesCount = (staticData?.subNodes || []).reduce((acc, subnodeArray) => acc + subnodeArray.length, 0);
                    
                    const adminAddedBrandsCount = adminData?.brands?.length || 0;
                    const adminAddedNodesCount = (adminData?.nodes || []).reduce((acc, subnodeArray) => acc + subnodeArray.length, 0);

                    const totalCoreBrands = staticBrandsCount + adminAddedBrandsCount;
                    const totalNodes = staticNodesCount + adminAddedNodesCount;

                    const row = tableBody.insertRow();
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                    
                    row.innerHTML = `
                        <td class="table-cell-padding text-xl">${summary.glyph}</td>
                        <td class="table-cell-padding font-semibold">${displayName}</td>
                        <td class="table-cell-padding">${totalCoreBrands}</td>
                        <td class="table-cell-padding">${totalNodes}</td>
                        <td class="table-cell-padding">R${parseFloat(summary.monthlyFee).toFixed(2)}</td>
                        <td class="table-cell-padding">R${parseFloat(summary.annualFee).toFixed(2)}</td>
                        <td class="table-cell-padding">${summary.payoutTier}</td>
                        <td class="table-cell-padding">${summary.region}</td>
                        <td class="table-cell-padding">
                            <button onclick="window.showAdminSection('sector-view-section', document.querySelector('.admin-nav-scroll a[data-section=\\'sector-view-section\\']')); document.getElementById('sectorViewSelect').value = '${sectorKey}'; window.displaySectorSpecificProducts('${sectorKey}')"
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                                Inspect
                            </button>
                        </td>
                        <td class="table-cell-padding">
                            <button onclick="window.deploySectorPlanToPayPal('${sectorKey}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs cta-button">
                                Deploy Plan
                            </button>
                        </td>
                    `;
                });
            }

            // --- Currency Converter Logic ---
            async function fetchExchangeRates() {
                if (API_KEY === "") {
                    console.warn("Currency converter: API_KEY is missing. Please get your API key from https://www.exchangerate-api.com/ and replace 'API_KEY' in the code. Currency conversion will not work without it.");
                    const selectElement = document.getElementById('sector-currency-select');
                    if (selectElement) selectElement.disabled = true;
                    return; 
                }
                try {
                    const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/${BASE_CURRENCY}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! Status: ${response.status}. API Error: ${errorData['error-type'] || 'Unknown error.'}`);
                    }
                    const data = await response.json();
                    if (data && data.conversion_rates) {
                        exchangeRates = data.conversion_rates;
                        console.log('Admin: Exchange rates fetched:', exchangeRates);
                    } else {
                        console.error('Admin: Failed to fetch conversion rates: Unexpected API response structure.', data);
                        const selectElement = document.getElementById('sector-currency-select');
                        if (selectElement) selectElement.disabled = true;
                    }
                } catch (error) {
                    console.error('Admin: Error fetching exchange rates:', error.message || error);
                    const selectElement = document.getElementById('sector-currency-select');
                    if (selectElement) selectElement.disabled = true;
                }
            }

            function getCurrencySymbol(currencyCode) {
                switch (currencyCode) {
                    case 'USD': return '$';
                    case 'EUR': return '€';
                    case 'GBP': return '£';
                    case 'ZAR': return 'R';
                    default: return currencyCode;
                }
            }
            
            // Function to update prices in the Sector View dynamically
            function updatePricesInSectorView(priceSpans, selectedCurrency) {
                const selectedSymbol = getCurrencySymbol(selectedCurrency);
                priceSpans.forEach(priceSpan => {
                    const isAnnual = priceSpan.innerHTML.includes('/ year'); // Check current billing cycle
                    const originalPriceValue = isAnnual ? parseFloat(priceSpan.dataset.originalAnnualPrice) : parseFloat(priceSpan.dataset.originalMonthlyPrice);
                    let convertedPrice = originalPriceValue;

                    if (selectedCurrency !== BASE_CURRENCY && exchangeRates[selectedCurrency]) {
                        convertedPrice = originalPriceValue * exchangeRates[selectedCurrency];
                    }
                    // Retain the / month or / year suffix
                    const suffix = isAnnual ? '/ year' : '/ month';
                    priceSpan.innerHTML = `${selectedSymbol}${convertedPrice.toFixed(2)} <span class="text-xl text-gray-400">${suffix}</span>`;
                    priceSpan.dataset.currencyCode = selectedCurrency;
                });
            }

            // --- PayPal Related Functions for Admin Portal (Deploy Plan) ---
            const YOUR_PAYPAL_PRODUCT_ID = 'YOUR_STATIC_PAYPAL_PRODUCT_ID_HERE'; 
            const PAYPAL_PLAN_IDS = {
                // These are placeholders. You NEED to replace these with your actual PayPal LIVE Plan IDs.
                // These come from the plans you create in your PayPal Developer Dashboard (after creating a product).
                "Agriculture & Biotech Starter Package_MONTHLY": "P-xxxxxxxxxxxxxxxxxxxx", // Example for a real ID
                "Agriculture & Biotech Starter Package_ANNUAL": "P-yyyyyyyyyyyyyyyyyyyy",
                "Agriculture & Biotech Pro Package_MONTHLY": "P-xxxxxxxxxxxxxxxxxxxx",
                "Agriculture & Biotech Pro Package_ANNUAL": "P-yyyyyyyyyyyyyyyyyyyy",
                "Agriculture & Biotech Enterprise Package_MONTHLY": "P-xxxxxxxxxxxxxxxxxxxx",
                "Agriculture & Biotech Enterprise Package_ANNUAL": "P-yyyyyyyyyyyyyyyyyyyy",
                
                // Add more plan IDs for each sector and tier as you deploy them via the 'Deploy Plan' button
                // Example for another sector:
                // "Banking & Finance Starter Package_MONTHLY": "P-yyyyyyyyyyyyyyyyyyyy",
                // "Banking & Finance Starter Package_ANNUAL": "P-zzzzzzzzzzzzzzzzzzzz",
                // "Banking & Finance Pro Package_MONTHLY": "P-yyyyyyyyyyyyyyyyyyyy",
                // "Banking & Finance Pro Package_ANNUAL": "P-zzzzzzzzzzzzzzzzzzzz",
                // "Banking & Finance Enterprise Package_MONTHLY": "P-yyyyyyyyyyyyyyyyyyyy",
                // "Banking & Finance Enterprise Package_ANNUAL": "P-zzzzzzzzzzzzzzzzzzzz",
                
                // You'll need to manually copy the generated LIVE Plan IDs from the deploy alert message
                // into this PAYPAL_PLAN_IDS object in your actual products.html and admin portal.
            };
            const CURRENT_USER_ID = 'CURRENT_LOGGED_IN_USER_ID'; // Replace with actual logged-in user ID if applicable

            async function deploySectorPlanToPayPal(sectorKey) {
                const deployButton = event.target;
                deployButton.disabled = true;
                deployButton.textContent = 'Deploying...';
                deployButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                deployButton.classList.add('bg-gray-400');

                if (YOUR_PAYPAL_PRODUCT_ID === 'YOUR_STATIC_PAYPAL_PRODUCT_ID_HERE') {
                    // IMPORTANT: Do NOT use `alert()`. Use a custom modal UI.
                    // For now, I'm just disabling the button and logging.
                    console.error('PayPal Product ID is not configured. Please replace YOUR_STATIC_PAYPAL_PRODUCT_ID_HERE.');
                    deployButton.disabled = false;
                    deployButton.textContent = 'Deploy Plan';
                    deployButton.classList.remove('bg-gray-400');
                    deployButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    return;
                }

                const sectorData = FAA_ZONE_INDEX_SUMMARY_DATA[sectorKey];
                const sectorDisplayName = sectorList[sectorKey];

                if (!sectorData) {
                    console.error(`Pricing data not found for sector: ${sectorKey}`);
                    deployButton.disabled = false;
                    deployButton.textContent = 'Deploy Plan';
                    deployButton.classList.remove('bg-gray-400');
                    deployButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    return;
                }

                const annualDiscount = 0.15; // 15% discount

                // Collect pricing for all tiers
                const baseMonthlyFee = parseFloat(String(sectorData.monthlyFee).replace('$', '').replace(',', ''));
                const monthlyPrices = {
                    "Starter": baseMonthlyFee,
                    "Pro": baseMonthlyFee * 2.5,
                    "Enterprise": baseMonthlyFee * 5
                };

                const annualPrices = {
                    "Starter": (baseMonthlyFee * 12 * (1 - annualDiscount)),
                    "Pro": (baseMonthlyFee * 2.5 * 12 * (1 - annualDiscount)),
                    "Enterprise": (baseMonthlyFee * 5 * 12 * (1 - annualDiscount))
                };


                try {
                    // This simulates sending a request to your backend (e.g., a Flask endpoint)
                    // which would then interact with the PayPal API to create the plans.
                    const response = await fetch(`/api/paypal?action=create-plans-for-sector`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productId: YOUR_PAYPAL_PRODUCT_ID,
                            sectorKey: sectorKey,
                            sectorDisplayName: sectorDisplayName,
                            monthlyPrices: monthlyPrices,
                            annualPrices: annualPrices, // Pass annual prices to backend
                            currencyCode: 'ZAR', // Your base currency for plan creation
                            tierPricingInfo: SECTOR_TIER_PRICING
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        let successMessage = `Successfully deployed PayPal plans for ${sectorDisplayName}!\n\n`;
                        result.createdPlans.forEach(plan => {
                            successMessage += `${plan.name} (${plan.billingCycle}): ID: ${plan.id}\n`;
                        });
                        // IMPORTANT: Do NOT use `alert()`. Use a custom modal UI.
                        console.log(successMessage + "\n\nIMPORTANT: These are LIVE Plan IDs! You need to manually copy these IDs from this alert into the PAYPAL_PLAN_IDS object in your `heyns-admin-portal.html` (and `products.html` if applicable) script for the 'Subscribe Now' buttons to work with these new plans.");
                        console.log('Deployed Plans (LIVE):', result.createdPlans);
                        deployButton.textContent = 'Deployed ✔️';
                        deployButton.classList.remove('bg-gray-400');
                        deployButton.classList.add('bg-green-700');
                    } else {
                        // IMPORTANT: Do NOT use `alert()`. Use a custom modal UI.
                        console.error(`Failed to deploy plans for ${sectorDisplayName}: ${result.error || 'Unknown error'}`);
                        console.error('Plan deployment error (LIVE):', result);
                        deployButton.textContent = 'Deploy Failed ❌';
                        deployButton.classList.remove('bg-gray-400');
                        deployButton.classList.add('bg-red-500');
                    }
                } catch (error) {
                    console.error('Error deploying PayPal plans (LIVE):', error);
                    // IMPORTANT: Do NOT use `alert()`. Use a custom modal UI.
                    console.error(`An error occurred while deploying plans for ${sectorDisplayName}. See console.`);
                    deployButton.textContent = 'Deploy Failed ❌';
                    deployButton.classList.remove('bg-gray-400');
                    deployButton.classList.add('bg-red-500');
                } finally {
                    setTimeout(() => {
                        deployButton.disabled = false;
                        deployButton.textContent = 'Deploy Plan';
                        deployButton.classList.remove('bg-green-700', 'bg-red-500');
                        deployButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    }, 5000);
                }
            }

            async function initiatePayPalSubscription(event) {
                const button = event.currentTarget;
                button.disabled = true;
                const originalButtonText = button.textContent;
                button.textContent = 'Processing...';

                const productName = button.dataset.itemName; 
                const billingCycle = button.dataset.billingCycle;
                const planKey = button.dataset.planKey; 
                const planId = PAYPAL_PLAN_IDS[planKey];

                if (!planId || planId.includes('YOUR_')) {
                    // IMPORTANT: Do NOT use `alert()`. Use a custom modal UI.
                    console.error(`Subscription plan ID not configured for "${productName}" (${billingCycle}). Please update PAYPAL_PLAN_IDS in the script with LIVE Plan IDs obtained after deploying plans.`);
                    console.error(`Missing or placeholder PayPal Plan ID for ${planKey}`);
                    button.disabled = false;
                    button.textContent = originalButtonText;
                    return;
                }

                const selectedCurrency = document.getElementById('sector-currency-select').value; 
                const amount = parseFloat(button.dataset.amount);

                try {
                    const response = await fetch(`/api/paypal?action=create-subscription`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            planId: planId,
                            userId: CURRENT_USER_ID,
                            productName: productName,
                            billingCycle: billingCycle,
                            currencyCode: selectedCurrency,
                            amount: amount
                        }),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        console.error('Backend create-subscription error:', result);
                        throw new Error(result.error || 'Failed to create PayPal subscription on backend');
                    }

                    if (result.approveUrl) {
                        window.location.href = result.approveUrl;
                    } else {
                        throw new Error('No approval URL received from PayPal.');
                    }

                } catch (error) {
                    console.error('Error initiating PayPal subscription:', error);
                    // IMPORTANT: Do NOT use `alert()`. Use a custom modal UI.
                    console.error(`An error occurred: ${error.message}. Please try again.`);
                    button.disabled = false;
                    button.textContent = originalButtonText;
                }
            }

            // Initial calls to populate data and display default sections on DOM Content Loaded
            document.addEventListener('DOMContentLoaded', () => {
                populateSectorSelect();
                populateSectorViewSelect(); 
                fetchExchangeRates(); 
                showAdminSection('add-brand-section', document.querySelector('.admin-nav-scroll a[data-section="add-brand-section"]'));
            });

        })(); // End of IIFE
    </script>
</body>
</html>
